<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heart Rate Monitor</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid #0f0;
      background-color: #000;
    }

    #bpm {
      font-size: 48px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Detak Jantung (BPM)</h1>
  <div id="bpm">0</div>
  <canvas id="ekgCanvas" width="800" height="300"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3VtggZ3POaniiW29w0a9hxpdL8tsT_B8",
      authDomain: "heartalv-bbb9f.firebaseapp.com",
      databaseURL: "https://heartalv-bbb9f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "heartalv-bbb9f",
      storageBucket: "heartalv-bbb9f.appspot.com",
      messagingSenderId: "419949588771",
      appId: "1:419949588771:web:d0b4a4d2b3b2312b505c96",
      measurementId: "G-8RDRRPGWMW"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const heartRateRef = ref(database, 'heartRateData/demo-device');

    let currentBPM = 0;
    let targetBPM = 0;
    let lastValidBPM = 75; // Default BPM awal
    let transitionStartTime = Date.now();
    const TRANSITION_DURATION = 1000;

    onValue(heartRateRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        const dates = Object.keys(data).sort().reverse();
        for (const date of dates) {
          if (typeof data[date] === "object") {
            const times = Object.keys(data[date]).sort().reverse();
            for (const time of times) {
              const bpmValue = data[date][time];
              if (bpmValue > 0) {
                targetBPM = bpmValue;
                lastValidBPM = bpmValue;
                transitionStartTime = Date.now();
                return;
              }
            }
          }
        }
      }
      // Jika tidak ada data valid, gunakan BPM terakhir yang valid
      targetBPM = lastValidBPM;
      transitionStartTime = Date.now();
    });

    function drawGrid(ctx, width, height) {
      ctx.strokeStyle = 'rgba(0, 255, 0, 0.2)';
      ctx.lineWidth = 0.5;
      for (let i = 0; i < width; i += 20) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, height);
        ctx.stroke();
      }
      for (let j = 0; j < height; j += 20) {
        ctx.beginPath();
        ctx.moveTo(0, j);
        ctx.lineTo(width, j);
        ctx.stroke();
      }
    }

    function smoothStep(start, end, progress) {
      progress = Math.min(1, Math.max(0, progress));
      return start + (end - start) * (progress * progress * (3 - 2 * progress));
    }

    window.onload = function () {
      const canvas = document.getElementById('ekgCanvas');
      const ctx = canvas.getContext('2d');
      drawGrid(ctx, canvas.width, canvas.height);

      let ekgData = [];
      let ekgIndex = 0;

      function animateECG() {
        const now = Date.now();
        const transitionProgress = (now - transitionStartTime) / TRANSITION_DURATION;
        currentBPM = smoothStep(currentBPM, targetBPM, transitionProgress);
        document.getElementById('bpm').innerText = Math.round(currentBPM);

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid(ctx, canvas.width, canvas.height);

        const centerY = canvas.height / 2;
        const ekgValue = Math.sin(ekgIndex * (Math.PI / 15)) * (currentBPM / 3) + centerY;
        ekgData.push(ekgValue);
        ekgIndex++;

        ctx.beginPath();
        ctx.moveTo(0, ekgData[0]);
        for (let i = 0; i < ekgData.length; i++) {
          ctx.lineTo(i, ekgData[i]);
        }
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 2;
        ctx.stroke();

        if (ekgData.length > canvas.width) {
          ekgData.shift();
        }

        requestAnimationFrame(animateECG);
      }

      animateECG();
    };
  </script>
</body>
</html>
